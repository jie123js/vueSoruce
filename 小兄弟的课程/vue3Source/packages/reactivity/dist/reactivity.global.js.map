{
  "version": 3,
  "sources": ["../src/index.ts", "../../shared/src/index.ts", "../src/effect.ts", "../src/baseHandler.ts", "../src/reactive.ts"],
  "sourcesContent": ["export{ reactive }from './reactive'\r\n\r\nexport {effect}from './effect'\r\n", "export const isObject = (value) => {\r\n  return typeof value === \"object\" && value !== null;\r\n};\r\n", "export let activeEffect = undefined;\r\n\r\nfunction cleanupEffect(effect) {\r\n  const { deps } = effect;\r\n  for (let i = 0; i < deps.length; i++) {\r\n    deps[i].delete(effect);\r\n  }\r\n  effect.deps.length = 0;\r\n}\r\n//todo TS\u4E2D\u7C7B\u7684\u5199\u6CD5\u4F1A\u6709\u70B9\u4E0D\u540C\r\nclass ReactiveEffect {\r\n  public active = true; //\u76F8\u5F53\u4E8Ethis.active = true\r\n  public parent = null;\r\n  public deps = []; //\u8FD9\u4E2A\u7528\u4E8Eeffect\u8BB0\u5F55\u5C5E\u6027  \u591A\u5BF9\u591A\u5173\u7CFB\r\n  constructor(public fn,public scheduler) {\r\n    //\u52A0\u4E86public\u76F8\u5F53\u4E8Ethis.fn=fn\r\n  }\r\n  run() {\r\n    if (!this.active) {\r\n      //\u5982\u679C\u975E\u6FC0\u6D3B\u4E0D\u7528\u4F9D\u8D56\u6536\u96C6\r\n      return this.fn();\r\n    }\r\n    try {\r\n      this.parent = activeEffect; //\u7B2C\u4E00\u6B21\u662Fnull  \u7B2C\u4E8C\u6B21\u8FDB\u6765\u56E0\u4E3A\u4E0A\u4E00\u6B21\u7684\u8FD8\u6CA1\u6267\u884C\u597D \u8BB0\u5F55\u4E0B\u4ED6\u7684\u7236\u4EB2\r\n      activeEffect = this;\r\n      //\u8FD9\u91CC\u6267\u884C\u524D\u6E05\u7A7A\u4E4B\u524D\u6536\u96C6\u7684\u5185\u5BB9\r\n      cleanupEffect(this);\r\n      return this.fn();\r\n    } finally {\r\n      activeEffect = this.parent;\r\n      this.parent = null; //\u7ED3\u675F\u540E\u6CA1\u5565\u610F\u4E49 \u6E05\u7A7A\u5C31\u597D\u4E86(\u53EF\u5199\u53EF\u4E0D\u5199)\r\n    }\r\n  }\r\n  stop(){\r\n    if(this.active){\r\n      this.active = false\r\n      cleanupEffect(this)\r\n    }\r\n   \r\n  }\r\n}\r\n\r\nexport function effect(fn,options:any={}) {\r\n  const _effect = new ReactiveEffect(fn,options.scheduler);\r\n  _effect.run();\r\n  const runner = _effect.run.bind(_effect)\r\n  runner.effect = _effect\r\n  return runner\r\n}\r\n\r\n//todo \u53EF\u80FD\u51FA\u73B0\u7684bug\r\n/* \r\neffect(()=>{\r\n  state.name ='n' //\u7B2C\u4E00\u6B21activeEffect = e1\r\n  effect(()=>{//\u7B2C\u4E8C\u6B21\u53C8new\u4E86\u4E00\u4E2Aeffect  \u7B2C\u4E8C\u6B21activeEffect = e2 \u7136\u540E\u76F4\u63A5finally,activeEffect=undefined\r\n    state.age = 2\r\n  })\r\n  state.add = 'xx' //\u6B64\u65F6\u8FD9\u4E2AactiveEffect=undefined\r\n}) */\r\n//todo \u89E3\u51B3\u65B9\u6CD5 \u5F04\u6210\u6811\u7ED3\u6784\u7ED9\u6BCF\u4E2Aclass\u6574\u4E00\u4E2Aparent\r\n\r\nconst targetMap = new WeakMap();\r\nexport function track(target, type, key) {\r\n  if (!activeEffect) return; //\u5982\u679C\u4E0D\u662F\u5728effect\u51FD\u6570\u91CC\u9762\u5199\u7684\u5C31\u4E0D\u4F9D\u8D56\u6536\u96C6\r\n\r\n  let depsMap = targetMap.get(target);\r\n  if (!depsMap) {\r\n    targetMap.set(target, (depsMap = new Map()));\r\n  }\r\n  let dep = depsMap.get(key);\r\n  if (!dep) {\r\n    depsMap.set(key, (dep = new Set()));\r\n  }\r\n  let shouldTrack = dep.has(activeEffect);\r\n  if (!shouldTrack) {\r\n    dep.add(activeEffect);\r\n    activeEffect.deps.push(dep); //\u4E4B\u540E\u6E05\u7406\u7684\u65F6\u5019\u4F1A\u7528\u5230,\u76EE\u524D\u8FD8\u6CA1\u7528\u5230\r\n  }\r\n}\r\n//\u76EE\u524D\u662F\u5355\u5411\u8BB0\u5F55,\u5C5E\u6027\u8BB0\u4F4F\u4E86effect,effect\u8FD8\u6CA1\u6709\u8BB0\u4F4F\u5C5E\u6027\r\n\r\nexport function trigger(target, type, key, value, oldValue) {\r\n  const depsMap = targetMap.get(target);\r\n  if (!depsMap) return; //\u89E6\u53D1\u7684\u503C\u4E0D\u5728\u6A21\u677F\u4E2D\r\n  let effects = depsMap.get(key);\r\n  if (effects) {\r\n    effects = new Set(effects); //\u6216\u8005 [...effects]  \u62F7\u8D1D\u4E00\u4EFD\u9632\u6B62\u5FAA\u73AF\u5F15\u7528\r\n    effects.forEach((effect) => {\r\n      if (effect == activeEffect) return; //\u8FD9\u4E2A\u662F\u9632\u6B62\u6B7B\u5FAA\u73AF \u4E00\u4E2A\u4F18\u5316\r\n      if(effect.scheduler){\r\n        effect.scheduler()\r\n      }else{\r\n        effect.run();\r\n      }\r\n     \r\n    });\r\n  }\r\n  /*  effects &&\r\n    effects.forEach((effect) => {\r\n      if (effect == activeEffect) return; //\u8FD9\u4E2A\u662F\u9632\u6B62\u6B7B\u5FAA\u73AF \u4E00\u4E2A\u4F18\u5316\r\n\r\n      effect.run();\r\n    }); */\r\n}\r\n", "import { isObject } from \"@vue/shared\";\r\nimport { activeEffect, track, trigger } from \"./effect\";\r\nimport { reactive } from \"./reactive\";\r\n\r\nexport const enum ReactiveFlags {\r\n  IS_REACTIVE = \"__v_isReactive\",\r\n}\r\n\r\nexport const mutableHandlers = {\r\n  get(target, key, receiver) {\r\n    if (key === ReactiveFlags.IS_REACTIVE) {\r\n      return true;\r\n    }\r\n    track(target, \"get\", key);\r\n    // activeEffect;\r\n    let res = Reflect.get(target, key, receiver);\r\n    if(isObject(res)){\r\n      return reactive(res)\r\n    }\r\n    return res\r\n  },\r\n  set(target, key, value, receiver) {\r\n    let oldValue = target[key];\r\n    let result = Reflect.set(target, key, value, receiver);\r\n    //todo \u8FD9\u4E2A\u662F\u505A\u4E00\u4E2A\u4F18\u5316\u5982\u679C\u4FEE\u6539\u503C\u6CA1\u53D8\u7684\u8BDD\u5C31\u4E0D\u89E6\u53D1\u66F4\u65B0\r\n    if (oldValue !== value) {\r\n      //\u8981\u66F4\u65B0\r\n      trigger(target, \"set\", key, value, oldValue);\r\n    }\r\n\r\n    return result;\r\n  },\r\n};\r\n", "import { isObject } from \"@vue/shared\";\r\nimport { mutableHandlers, ReactiveFlags } from \"./baseHandler\";\r\nconst reactiveMap = new WeakMap();\r\n\r\n\r\nexport function reactive(target) {\r\n  if (!isObject(target)) {\r\n    return;\r\n  }\r\n  /* \u8FD9\u4E2A\u662F\u5904\u7406\u8FD9\u79CD\u60C5\u51B5\u7684\u7F13\u5B58\r\n   let obj = {name:'zj'}\r\n    let r1 = reactive(obj)\r\n    let r2 =reactive(obj)\r\n  */\r\n  let exisitingProxy = reactiveMap.get(target);\r\n  if (exisitingProxy) {\r\n    return exisitingProxy;\r\n  }\r\n  //todo \u51FA\u73B0\u5BF9\u4EE3\u7406\u8FC7\u7684\u5BF9\u8C61\u518D\u8FDB\u884C\u4EE3\u7406\r\n   /* \u8FD9\u4E2A\u662F\u5904\u7406\u8FD9\u79CD\u60C5\u51B5\u7684\u7F13\u5B58\r\n   let obj = {name:'zj'}\r\n    let r1 = reactive(obj)\r\n    let r2 =reactive(r1)\r\n  */\r\n if(target[ReactiveFlags.IS_REACTIVE]){\r\n     return target\r\n }\r\n  const proxy = new Proxy(target, mutableHandlers);\r\n  reactiveMap.set(target, proxy);\r\n  return proxy;\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
